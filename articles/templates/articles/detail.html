{% extends 'base.html' %}
{% load django_bootstrap5 %}
{% load static %}

{% block content %}
<div class="my-5 mx-5 text-bg-light">
  {% comment %} <h2 class="text-center fw-bold my-3">커뮤니티</h2> {% endcomment %}
  <span class="d-none">{{ article.update_hits }}</span>
  <h1>제목: {{ article.title }}</h1>
  <div class="d-flex justify-content-between">
    <p>작성자: {{ article.user }}</p>
    <div>
      <p>작성시간: {{ article.created_at }}</p>
      <p>수정시간: {{ article.updated_at }}</p>
    </div>
  </div>
  <p>카테고리: {{ article.category }}</p>
  <h2>내용: {{ article.content }}</h2>
  <p class="text-center">조회수: {{ article.hits }}</p>
  {% comment %} <h2>좋아요: {{ article.user_article_like }}</h2> {% endcomment %}
</div>
<div class="mx-5">
{% comment %} 댓글 작성 {% endcomment %}
<form id="comment-form" data-article-id="{{ article.pk }}">
  {% csrf_token %}
  <div class="d-flex w-100">
    {% bootstrap_form comment_form %}
    <button type="submit" class="btn btn-dark ms-2" style="height:2.4rem;">ok</button>
  </div>
</form>

<h4 class="mb-3 fw-bold">댓글 목록</h4>
  <div id="comments">
    {% for comment in comments %}
      <div id="comment">
        <span> {{ comment.user.username }} | {{ comment.content }}</span>
        {% if request.user.pk == comment.user.pk %}
          <div id="form-comment-update-{{ comment.pk }}" style="display:none;">
            <input id="input-{{ comment.pk }}" type="text" value="{{comment.content}}">
            <button onclick="ok_function(this)" id="okBtn-{{ comment.pk }}" data-article-id="{{ article.pk }}" data-comment-id="{{ comment.pk }}">확인</button>
            <button>취소</button>
          </div>
          <button onclick="update_comment(this)" id="comment-update-{{ comment.pk }}" data-article-id="{{ article.pk }}" data-comment-id="{{ comment.pk }}">수정</button>
          <button onclick="delete_comment(this)" id="comment-delete-{{ comment.pk }}" data-article-id="{{ article.pk }}" data-comment-id="{{ comment.pk }}">삭제</button>
        {% endif %}
        <hr>   
      </div> 
    {% empty %}
      <p>댓글이 없어요 ㅠ_ㅠ</p>
    {% endfor %}
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // 댓글 생성 비동기
  const commentForm = document.querySelector('#comment-form')
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value
  commentForm.addEventListener('submit', function(event) {
    event.preventDefault();
    console.log('dddddddd')
    axios({
      method: 'post',
      url: `/${event.target.dataset.articleId}/comments/create/`,
      headers: {'X-CSRFToken': csrftoken},
      data: new FormData(commentForm) 
    })
    .then(response => {
      const comments = document.querySelector('#comments')
      comments.textContent = "";
      const hr = document.createElement('hr')
      const comment_data = response.data.comment_data
      const user = response.data.user
      for (let i = 0; i < comment_data.length; i++) {
        const article_pk = response.data.article_pk
        if (user === comment_data[i].userId ){
        comments.insertAdjacentHTML('beforeend', `
          <span> ${ comment_data[i].userName } | ${ comment_data[i].content }</span>
          <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
            <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
            <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">확인</button>
            <button>취소</button>
          </div>
            <button onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">수정</button>
            <button onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">삭제</button>
            <hr>
          `);
        } else {
          comments.insertAdjacentHTML('beforeend', `
          <span> ${ comment_data[i].userName } | ${ comment_data[i].content }</span>
          <hr>
          `);
        }
      }
      commentForm.reset()
    })
    .catch(console.log(1))
  }) 
</script>

<script>
  // 댓글 수정 비동기
  const ok_function = (e) => {
    const commentId = event.target.dataset.commentId
    const articleId = event.target.dataset.articleId
    const inputCommentPk = document.querySelector(`#input-${ commentId }`)
    
    axios({
      method: 'post',
      url: `/${articleId}/comments/${commentId}/update/`,
      headers: {'X-CSRFToken': csrftoken},
      data: {'content': inputCommentPk.value}
    })
    .then(response => {
      const comments = document.querySelector('#comments')
      comments.textContent = "";
      const hr = document.createElement('hr')
      const comment_data = response.data.comment_data
      const user = response.data.user
      
      for (let i = 0; i < comment_data.length; i++) {
        const article_pk = response.data.article_pk
        if (user === comment_data[i].userId ){
        comments.insertAdjacentHTML('beforeend', `
          <span> ${ comment_data[i].userName } | ${ comment_data[i].content }</span>
          <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
            <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
            <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">확인</button>
            <button>취소</button>
          </div>
            <button onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">수정</button>
            <button onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">삭제</button>
            <hr>
          `);
        } else {
          comments.insertAdjacentHTML('beforeend', `
          <span> ${ comment_data[i].userName } | ${ comment_data[i].content }</span>
          <hr>
          `);
        }
      }
    })
    
  }
  const update_comment = (e) => {
    const comment_id = document.querySelector(`#${e.id}`).id
    const input = document.createElement('input')
    const comment = document.querySelector('#comment')
    const span = document.createElement('span')
    const comment_update_form = document.querySelector(`#form-${ e.id }`)
    comment_update_form.style.display = ""

  
  }

  // 댓글 삭제 비동기
  const delete_comment = (e) => {
    const comment_id = document.querySelector(`#${e.id}`).id
    axios({
      method: 'post',
      url: `/${event.target.dataset.articleId}/comments/${event.target.dataset.commentId}/delete/`,
      headers: {'X-CSRFToken': csrftoken},
    })
    .then(response => {
      const comments = document.querySelector('#comments')
      comments.textContent = "";
      const hr = document.createElement('hr')
      const comment_data = response.data.comment_data
      const user = response.data.user
      
      for (let i = 0; i < comment_data.length; i++) {
        const article_pk = response.data.article_pk
        if (user === comment_data[i].userId ){
        comments.insertAdjacentHTML('beforeend', `
          <span> ${ comment_data[i].userName } | ${ comment_data[i].content }</span>
          <div id="form-comment-update-${comment_data[i].commentPk}" style="display:none;">
            <input id="input-${comment_data[i].commentPk}" type="text" value="${comment_data[i].content}">
            <button onclick="ok_function(this)" id="okBtn-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">확인</button>
            <button>취소</button>
          </div>
            <button onclick="update_comment(this)" id="comment-update-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">수정</button>
            <button onclick="delete_comment(this)" id="comment-delete-${comment_data[i].commentPk}" data-article-id="${article_pk}" data-comment-id="${comment_data[i].commentPk}">삭제</button>
            <hr>
          `);
        } else {
          comments.insertAdjacentHTML('beforeend', `
          <span> ${ comment_data[i].userName } | ${ comment_data[i].content }</span>
          <hr>
          `);
        }
      }
    })
  }
</script>
{% endblock %}
